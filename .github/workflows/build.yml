name: Upload Plugin JAR and server.py

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  build-plugin:
    name: Build Plugin
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: ☕ Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 22

      - name: 🚀 Build plugin with Maven
        run: mvn clean package

      - name: 🧼 Prepare output
        run: |
          mkdir -p out
          cp target/LiveUpdater-*.jar out/LiveUpdater.jar
          cp server.py out/server.py

      - name: 🏷️ Get version from JAR name
        id: get_version
        run: |
          FILE=$(ls target/LiveUpdater-*.jar | head -n 1)
          VERSION=$(echo $FILE | sed -E 's/.*LiveUpdater-([0-9]+\.[0-9]+\.[0-9]+)\.jar/\1/')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "::set-output name=version::$VERSION"

      - name: 🚀 Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          name: "LiveUpdater v${{ steps.get_version.outputs.version }}"
          tag_name: "v${{ steps.get_version.outputs.version }}"
          files: |
            out/LiveUpdater.jar
            out/server.py
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}